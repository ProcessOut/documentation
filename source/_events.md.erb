# Events

When a transaction receive an update (such as when its state changes from
pending to completed, or if the transaction gets reversed), ProcessOut creates
an event which can be fetched and processed.

ProcessOut may also fire events not directly related to a transaction, such as
when the project gets updated.

## Fetching events

```javascript
var events = ProcessOut.Event.pull();
for (var i = 0; i < events.length; i++)
{
    var event = events[i];
    var data  = event.getData();
    // Do stuff on the event with its data

    // Once you're done with the event, you may mark it
    // as processed so that pull() won't return it anymore.
    event.markProcessed();
}

// You may also find a specific not-processed event by its id
var event = ProcessOut.Event.find('<event-id>');
// And mark it as processed once done with it
event.markProcessed();
```

```python
from processout.event import Event

events = Event.pull()
for event in events:
    var data = event.data
    # Do stuff on the event with its data

    # Once you're done with the event, you may mark it
    # as processed so that pull() won't return it anymore.
    event.markProcessed()

# You may also find a specific not-processed event by its id
event = Event.find('<event-id>')
# And mark it as processed once done with it
event.markProcessed()
```

```php
<?php
$events = ProcessOut\Event::pull();
foreach($events as $event)
{
    $data = $event->getData();
    // Do stuff on the event with its data

    // Once you're done with the event, you may mark it
    // as processed so that pull() won't return it anymore.
    $event->markProcessed();
}

// You may also find a specific not-processed event by its id
$event = ProcessOut\Event::find('<event-id>');
// And mark it as processed once done with it
$event->markProcessed();
?>
```

Events can be fetched using the API, and they would then work as a queue
(first in, first out). This means that you always get the first not-processed
event. Once an event is marked as processed, it will not be listed by the API
anymore. Simply fetching an event from ProcessOut will **not** mark an event
as processed, it needs to be done explicitely.

One could imagine setting up a background worker continuously fetching events
from ProcessOut.

You may access the actual [data](#data) related to the event in its `data` field.

We also provide [webhooks](#webhooks) to conveniently manage transaction events.

## Invoice events

The different events ProcessOut currently offers are listed below. You may also
see the related `action` on the right pane, which is essentially the name of the
event.

### Completed

```
invoice.completed
```

The transaction has been completed, and can be trusted. Once the transaction
reaches this state, you should be safe to deliver your customer what he paid for.

### Pending

```
invoice.pending
```

The payment has been placed, but the transaction hasn't been completed yet.
You should wait for the completed state.

### Failed

```
invoice.failed
```

The payment had been placed, but it failed. If you had previously given
your customer access, you should revoke it.

### Disputed

```
invoice.disputed
```

The payment had been placed and the transaction completed, but your customer
disputed the transaction on the payment gateway website (such as PayPal).
In most cases, this means that you already gave your customer access to what
he paid for, so you may wish to revoke their access.

### Solved

```
invoice.solved
```

The dispute that your customer opened has been solved, and the funds have been
restored to your account. At this point, you may wish to give back to your
customer the access to what he paid for.

### Refunded

```
invoice.refunded
```

The dispute opened by your customer has been solved in his favor, and you
permanently lost the funds. You should permanently revoke your customer's access.

### Reversed

```
invoice.reversed
```

The payment had been placed and the transaction completed, but your customer
reversed the payment, most likely through their bank. In most cases, it's hard to
recover the funds so you should permanently revoke your customer's access.

## Recurring invoice events

In addition to the previous invoice events, ProcessOut also provides
events related to your recurring invoices.

### Started

```
recurring-invoice.started
```

The recurring invoice cycle started, and you may activate your customer's
subscription.

### Ended

```
recurring-invoice.ended
```

Your customer recurring invoice cycle stopped/ended. You may revoke your
customer's access.

## Data

```json
{
    "action": "invoice.completed",
    "metas": {
        "Meta 1": "data 1",
        "Meta 2": "data 2"
    },
    "custom":         null,
    "hmac_signature": "Q4aUOlHGhbrcnjAdS1mJmTwBp6W8TI+52UT5tcEblws=",
    "project_id":     "fced400c-6d63-48a1-a68a-748295017100",
    "transaction_id": "7fa334ca-7714-4eaa-8961-d34953298d08",
    "item": {
        "name":     "Amazing item",
        "price":    42.00,
        "taxes":    24.00,
        "shipping": 4.20,
        "total":    70.20,
        "currency": "EUR"
    },
    "customer": {
        "email":        "john@smith.com",
        "first_name":   "John",
        "last_name":    "Smith",
        "address1":     "42 John street",
        "address2":     "Suite B",
        "city":         "Paris",
        "state":        "",
        "zip":          "75000",
        "country_code": "FR"
    },
    "customer_gateway": {
        "name":    "John Smith",
        "email":   "john@smith.com",
        "address": "42 John street, 42000 City, Country",
        "phone":   "+14444444444"
    },
    "gateway": {
        "name":     "paypal",
        "response": [

        ],
        "payment_id":   "7fa334ca-7714-4eaa-8961-d34953298d08",
        "fee":          4.20,
        "fee_currency": "USD"
    },
    "sandbox": true
}
```

Data sent with events and [webhooks](#webhooks) are all normalized to be as
easy to use and remember as possible. You will find the most common data
pattern sent on the right pane. Please keep in mind that some data may not be
sent depending on the action.

You may access this data in the `data` field of the event.

| Field | Description |
| ----- | ----------- |
| action | [Event name](#invoice-events) |
| metas  | Meta data sent when creating the invoice |
| custom | Custom value sent when creating the invoice |
| hmac_signature | Signature used to check the authencity of the webhook / event |
| project_id | Project id under which the invoice was created |
| transaction_id | Transaction id linked to the invoice |
| item | Information related to the item that was sold |
| customer | Data related to the customer, which was requested during the checkout |
| customer_gateway | Data related to the customer, returned by the payment gateway |
| gateway | Data related to the payment gateway, including its name, raw response and fees |
| sandbox | Boolean. Sandbox enabled if true |
