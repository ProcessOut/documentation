## Webhooks

Processing [events](#events) can also be done through webhooks (also called
callbacks or Instant Payment Notification: IPN). It is essentially a web
request made to your web application, posting the data related to the event.
Webhooks can be used to automatically deliver an item upon successful
payment, for instance, without the need for an application running in the
background.

However, as many payment gateways can be used at the same time, ProcessOut
provides webhooks containing unified, normalized and easy to use data, as well
as transaction states corresponding to the triggered event.

### Pre-requisites

In order to start receiving webhooks, you must add your `notify_url`s in your
[ProcessOut dashboard](https://dashboard.processout.com).

You should also note that *we will always `POST` a json encoded body request*
to your application. Therefore, you should accept POST requests with a json body.

Furthermore, you should *remove all CSRF protection* on your endpoints receiving
webhooks. Most frameworks and CMS activate it by default, which could
prevent ProcessOut from correctly posting webhooks to your application.


### Usage

```javascript
// Let's assume reqRaw is filled with the raw request content
// and req is filled with the decoded json data from the request body

// We first need to check that the callback is coming from ProcessOut
var callback = new ProcessOut.Callback();
if (! callback.validate(reqRaw)) {
    console.log('Bad webhook');
    return;
}

// Then make sure the event isn't coming from the sandbox (if in production)
if ('sandbox' in req && req['sandbox']) {
    console.log('Not in sandbox env');
    return;
}

// Webhook is legit! Perform actions on it
switch (input['name']) {
case 'invoice.transaction.completed':
    // Transaction successful
    break;
case 'invoice.transaction.pending':
    // Transaction still needs some time to be processed
    break;
// ...
default:
    console.log('Unknown webhook action');
    return;
}
```

```python
from processout.callback import Callback

# Let's assume reqRaw is filled with the raw request content
# and req is filled with the decoded json data from the request body

# We first need to check that the webhook is coming from ProcessOut
callback = Callback()
if not callback.validate(reqRaw):
    print ('Bad webhook')
    return

# Webhook is legit! Perform actions on it
if req['name'] == 'invoice.transaction.completed':
    # Transaction successful
    pass

elif req['name'] == 'invoice.transaction.pending':
    # Transaction still needs some time to be processed
    pass

# ...

else:
    # Shouldn't be here..
    print('Unknown webhook action')
```

```php
<?php
$reqRaw = file_get_contents('php://input');
$req    = json_decode($reqRaw, true);

// We first need to check that the callback is coming from ProcessOut
$callback = new \ProcessOut\Callback();
if (! $callback->validate($reqRaw))
{
    echo 'Bad webhook'; exit();
}

// Then make sure the event isn't coming from the sandbox (if in production)
if (! empty($req['sandbox']) && $req['sandbox']) {
    echo 'Not in sandbox env'; exit();
}

// Webhook is legit! Perform actions on it
switch($req['name'])
{
case 'invoice.transaction.completed':
    // Transaction successful
    break;
case 'invoice.transaction.pending':
    // Transaction still needs some time to be processed
    break;
// ...
default:
    echo 'Unknown webhook action'; exit();
}
?>
```

Now that your webhook is correctly set up, we need to make sure it is correctly
processed and authenticated by your application.

You should also make sure that when deployed on your production environment,
you do not accept sandbox webhooks anymore.

Once correctly processed by your application, you should always return a
`status 200 response`. If you don't, ProcessOut will try to send the webhook
again, waiting an increasing amount of time between each tries.
